<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <title>CINEMA PRO - Relay Edition</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #0a0a0a; color: #00ff41; font-family: 'Courier New', monospace; text-align: center; padding: 20px; }
        .main-card { background: #111; border: 2px solid #00ff41; border-radius: 10px; padding: 20px; max-width: 800px; margin: auto; box-shadow: 0 0 20px #00ff41; }
        .input-group { margin: 20px 0; display: flex; justify-content: space-around; gap: 10px; }
        input { background: #000; border: 1px solid #00ff41; color: #00ff41; padding: 10px; width: 60%; }
        button { cursor: pointer; padding: 10px 20px; font-weight: bold; text-transform: uppercase; }
        .btn-host { background: #00ff41; color: #000; border: none; }
        .btn-join { background: #000; color: #00ff41; border: 1px solid #00ff41; }
        #status-log { background: #000; border: 1px solid #333; height: 150px; overflow-y: auto; text-align: left; padding: 10px; font-size: 13px; margin-top: 10px; color: #888; }
        video { width: 100%; margin-top: 20px; border: 1px solid #333; background: #000; }
        .highlight { color: #fff; font-weight: bold; }
    </style>
</head>
<body>

<div class="main-card">
    <h2>[ BIOSKOP SISTEM v4.0 ]</h2>
    
    <div class="input-group">
        <div>
            <p>1. KREIRAJ KANAL</p>
            <input type="text" id="myId" placeholder="Ime (npr: lulehbo)">
            <button class="btn-host" onclick="startHost()">POKRENI</button>
        </div>
        <div>
            <p>2. PRIDRUŽI SE</p>
            <input type="text" id="targetId" placeholder="Ime kanala">
            <button class="btn-join" onclick="startGuest()">POVEŽI SE</button>
        </div>
    </div>

    <div id="status-log">Sistem spreman... Čekam unos.</div>
    
    <video id="v" autoplay playsinline controls></video>
</div>

<script>
    const status = document.getElementById('status-log');
    const video = document.getElementById('v');
    let peer = null;

    // KONFIGURACIJA SA TURN SERVEROM ZA ZAOBILAŽENJE BLOKADA
    const peerConfig = {
        config: {
            'iceServers': [
                { 'urls': 'stun:stun.l.google.com:19302' },
                { 'urls': 'stun:stun1.l.google.com:19302' },
                { 
                    'urls': 'turn:openrelay.metered.ca:80', 
                    'username': 'openrelayproject', 
                    'credential: 'openrelayproject' 
                }
            ]
        },
        debug: 3
    };

    function log(msg) {
        status.innerHTML += `<br>> ${msg}`;
        status.scrollTop = status.scrollHeight;
    }

    async function startHost() {
        const id = document.getElementById('myId').value;
        if(!id) return alert("Unesi ime kanala!");

        peer = new Peer(id, peerConfig);
        log("Inicijalizacija servera...");

        peer.on('open', async (openedId) => {
            log(`KANAL OTVOREN: <span class="highlight">${openedId}</span>`);
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { frameRate: 30 },
                    audio: true
                });
                video.srcObject = stream;
                log("Strim pokrenut. Čekam drugara...");

                peer.on('call', call => {
                    log("Detektovan poziv! Šaljem podatke...");
                    call.answer(stream);
                });
            } catch(e) {
                log("GREŠKA: Nisi dozvolio deljenje ekrana.");
            }
        });

        peer.on('error', e => log("GREŠKA: " + e.type));
    }

    function startGuest() {
        const tid = document.getElementById('targetId').value;
        if(!tid) return alert("Unesi ime hosta!");

        log("Pokušavam povezivanje sa: " + tid);
        peer = new Peer(peerConfig);

        peer.on('open', () => {
            const call = peer.call(tid, null);
            log("Zahtev poslat preko relej servera...");

            call.on('stream', remoteStream => {
                log("<span class="highlight">VEZA USPEŠNA! Uživaj u filmu.</span>");
                video.srcObject = remoteStream;
            });

            setTimeout(() => {
                if(!video.srcObject) log("Vreme isteklo. Host nije odgovorio.");
            }, 15000);
        });

        peer.on('error', e => log("GREŠKA GOSTA: " + e.type));
    }
</script>
</body>
</html>
